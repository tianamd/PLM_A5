<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Lifecycle Management</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        h1 {
            text-align: center;
        }
        form {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }
        .filter-group {
            margin: 10px;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .collapsible {
            background-color: #f1f1f1;
            color: black;
            cursor: pointer;
            padding: 10px;
            border: 1px solid #ccc;
            text-align: left;
            outline: none;
            font-size: 16px;
            width: 100%;
        }
        .collapsible:hover {
            background-color: #ddd;
        }
        .content {
            display: none;
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-top: none;
            background-color: #f9f9f9;
            overflow-y: auto;
            max-height: 150px;
        }
        .content label {
            display: block;
            margin-bottom: 5px;
        }
        .content input[type="checkbox"] {
            margin-right: 10px;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        th {
            background-color: #f2f2f2;
            text-align: left;
        }
        th a {
            text-decoration: none;
            color: black;
        }
        th a:hover {
            text-decoration: underline;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>
    <h1>Product Lifecycle Management</h1>
    {% if session.get('username') %}
        <div style="text-align: right;">
            Logged in as: {{ session['username'] }} | 
            <a href="{{ url_for('logout') }}">Logout</a>
        </div>
    {% endif %}
    
    {% if session.get('type') in ['admin', 'manager'] %}
        <a href="{{ url_for('add_product') }}">Add Product</a>
    {% endif %}
    
    {% if session.get('type') == 'admin' %}
        <a href="{{ url_for('manage_users') }}" class="btn btn-primary">Manage Users</a>
    {% endif %}



    <!-- Filter Form -->
    <form method="GET" action="{{ url_for('index') }}">

        <!-- Ranges -->
        <div class="filter-group">
            <button type="button" class="collapsible">Range</button>
            <div class="content">
                {% for range in ranges %}
                    <label>
                        <input type="checkbox" name="ranges" value="{{ range.id }}" 
                               {% if range.id in selected_ranges %}checked{% endif %}>
                        {{ range.name }}
                    </label>
                {% endfor %}
            </div>
        </div>

        <!-- Product Name -->
        <div class="filter-group">
            <button type="button" class="collapsible">Product Name</button>
            <div class="content">
                {% for product in products %}
                    <label>
                        <input type="checkbox" name="name" value="{{ product.name }}" 
                               {% if product.name in request.args.getlist('name') %}checked{% endif %}>
                        {{ product.name }}
                    </label>
                {% endfor %}
            </div>
        </div>

        <!-- Notes -->
        <div class="filter-group">
            <button type="button" class="collapsible">Notes</button>
            <div class="content">
                {% for note in notes %}
                    <label>
                        <input type="checkbox" name="notes" value="{{ note.name }}" 
                               {% if note.name in request.args.getlist('notes') %}checked{% endif %}>
                        {{ note.name }}
                    </label>
                {% endfor %}
            </div>
        </div>

        <!-- Compositions -->
        <div class="filter-group">
            <button type="button" class="collapsible">Compositions</button>
            <div class="content">
                {% for composition in compositions %}
                    <label>
                        <input type="checkbox" name="compositions" value="{{ composition.name }}" 
                               {% if composition.name in request.args.getlist('compositions') %}checked{% endif %}>
                        {{ composition.name }}
                    </label>
                {% endfor %}
            </div>
        </div>

        <!-- Format -->
        <div class="filter-group">
            <button type="button" class="collapsible">Format</button>
            <div class="content">
                {% for format in formats %}
                    <label>
                        <input type="checkbox" name="format" value="{{ format }}" 
                               {% if request.args.get('format') == format %}checked{% endif %}>
                        {{ format }}
                    </label>
                {% endfor %}
            </div>
        </div>

        <!-- Price Range -->
        <div class="filter-group">
            <label for="min_price">Price Range (Retail Price):</label>
            <input type="number" name="min_price" id="min_price" placeholder="Min Price" 
                   value="{{ request.args.get('min_price', '') }}">
            <input type="number" name="max_price" id="max_price" placeholder="Max Price" 
                   value="{{ request.args.get('max_price', '') }}">
        </div>

        <!-- Submit Button -->
        <div class="filter-group" style="align-self: center;">
            <button type="submit">Apply Filters</button>
        </div>
        
            <!-- Export CSV Button -->
        <div class="filter-group" style="align-self: center;">
            <button type="submit" formaction="{{ url_for('export_csv') }}">Export CSV</button>
        </div>    
    </form>
    

    <!-- Product Table -->
    <table>
        <thead>
            <tr>
                <th>Image</th>
                <th><a href="{{ url_for('index', sort='status', order='asc' if sort_column != 'status' or sort_order == 'desc' else 'desc') }}">Status</a></th>
                <th><a href="{{ url_for('index', sort='persons_in_charge', order='asc' if sort_column != 'persons_in_charge' or sort_order == 'desc' else 'desc') }}"></a>Persons in Charge</a></th>
                <th><a href="{{ url_for('index', sort='start_date', order='asc' if sort_column != 'start_date' or sort_order == 'desc' else 'desc') }}">Start Date</a></th>
                <th><a href="{{ url_for('index', sort='ref', order='asc' if sort_column != 'ref' or sort_order == 'desc' else 'desc') }}">Reference</a></th>
                <th><a href="{{ url_for('index', sort='range_name', order='asc' if sort_column != 'range_name' or sort_order == 'desc' else 'desc') }}">Range</a></th>
                <th><a href="{{ url_for('index', sort='name', order='asc' if sort_column != 'name' or sort_order == 'desc' else 'desc') }}">Product Name</a></th>
                <th><a href="{{ url_for('index', sort='format', order='asc' if sort_column != 'format' or sort_order == 'desc' else 'desc') }}">Format</a></th>
                <th><a href="{{ url_for('index', sort='cost', order='asc' if sort_column != 'cost' or sort_order == 'desc' else 'desc') }}">Cost</a></th>
                <th>Notes</th>
                <th>Composition</th>
                <th>Description</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for product in products %}
                <tr>
                    <td>
                        <img src="{{ product.image_path }}" alt="" style="width: 50px; height: auto;">
                    </td>
                    <td>{{ product.status }}</td>
                    <td>{{ ", ".join(product.persons_in_charge) }}</td>
                    <td>{{ product.start_date }}</td>
                    <td>{{ product.ref }}</td>
                    <td>{{ product.range_name }}</td>
                    <td>
                        <a href="{{ url_for('product_detail', product_id=product.id) }}">{{ product.name }}</a>
                    </td>
                    <td>{{ product.format }}</td>
                    <td>{{ product.cost }}</td>
                    <td>{{ ", ".join(product.notes) }}</td>
                    <td>{{ ", ".join(product.compositions) }}</td>
                    <td>{{ product.description }}</td>
                        <td>
                            {% if session['username'] in product.persons_in_charge or session['type'] in ['manager', 'admin'] %}
                                <form action="{{ url_for('update_product', product_id=product.id) }}" method="GET" style="display:inline;">
                                    <button type="submit">Update</button>
                                </form>
                                <!-- Status Update Button -->
                                {% if product.status in ['Initial', 'In progress'] %}
                                    {% if product.status == "In progress" %}
                                        <form action="{{ url_for('update_product_status', product_id=product.id) }}" method="POST" style="display:inline;">
                                            <input type="hidden" name="action" value="to_to_be_validated">
                                            <button type="submit">Set to Be Validated</button>
                                        </form>
                                    {% endif %}
                                    {% if product.status == "Initial" %}
                                        <form action="{{ url_for('update_product_status', product_id=product.id) }}" method="POST" style="display:inline;">
                                            <input type="hidden" name="action" value="to_in_progress">
                                            <button type="submit">Set to In Progress</button>
                                        </form>
                                    {% endif %}
                                {% endif %}
                                {% if product.status == 'To be validated' %}
                                    {% if session['type'] in ['manager', 'admin'] %}
                                        <form action="{{ url_for('update_product_status', product_id=product.id) }}" method="POST" style="display:inline;">
                                            <input type="hidden" name="action" value="to_done">
                                            <button type="submit">Mark as Done</button>
                                        </form>
                                        <form action="{{ url_for('update_product_status', product_id=product.id) }}" method="POST" style="display:inline;">
                                            <input type="hidden" name="action" value="to_in_progress">
                                            <button type="submit">Revert to In Progress</button>
                                        </form>
                                    {% endif %}
                                {% endif %}
                                {% if product.status == 'Archived' or  product.status == 'Done'%}
                                    {% if session['type'] in ['manager', 'admin'] %}
                                        <form action="{{ url_for('update_product_status', product_id=product.id) }}" method="POST" style="display:inline;">
                                            <input type="hidden" name="action" value="to_in_progress">
                                            <button type="submit">Revert to In Progress</button>
                                        </form>
                                    {% endif %}
                                {% endif %}
                                <!-- Archive Button -->
                                {% if product.status != 'Archived'%}
                                    <form action="{{ url_for('update_product_status', product_id=product.id) }}" method="POST" style="display:inline;">
                                        <input type="hidden" name="action" value="archive">
                                        <button type="submit">Archive</button>
                                    </form>
                                {% endif %}
                                {% if session.get('type') == 'admin' %}
                                    <form action="{{ url_for('delete_product', product_id=product.id) }}" method="POST" style="display:inline;">
                                        <input type="hidden" name="action" value="delete">
                                        <button type="submit" onclick="return confirm('Are you sure you want to delete this product?');">Delete</button>
                                    </form>
                                {% endif %}
                            {% else %}
                                <span>N/A</span>
                            {% endif %}
                        </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- JavaScript for Collapsible Sections -->
    <script>
        document.querySelectorAll('.collapsible').forEach(button => {
            button.addEventListener('click', () => {
                const content = button.nextElementSibling;
                content.style.display = content.style.display === 'block' ? 'none' : 'block';
            });
        });
    </script>
</body>
</html>
